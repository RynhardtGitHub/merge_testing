<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Canvas Example</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            background-color: #b9b9b9;
        }
        header {
            background-color: #b9b9b9;
            color: #000;
            padding: 10px;
            text-align: center;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }
        #canvasContainer {
            flex: 1;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #canvas {
            background-color: #fff;
            max-width: 100%;
            max-height: 100%;
        }
        .buttons {
            display: flex;
            gap: 10px;
        }
        .buttons button {
            background-color: #c80000; 
            color: white; 
            padding: 10px 20px;
            border-radius: 5px; 
            font-size: 16px;
            cursor: pointer;
        }
        footer {
            background-color: #b9b9b9;
            color: #000;
            text-align: center;
            padding: 10px;
        }
    </style>
</head>
<body>
    <header>
        <div id="hearts">
            <img src="heart.png" alt="Heart" width="30" height="30">
            <img src="heart.png" alt="Heart" width="30" height="30">
            <img src="heart.png" alt="Heart" width="30" height="30">
            <img src="heart.png" alt="Heart" width="30" height="30">
            <img src="heart.png" alt="Heart" width="30" height="30">
        </div>
        <div class="buttons">
            <button id="restartButton">Allow permission</button>
        </div>
    </header>
    <div id="canvasContainer">
        <canvas id="canvas"></canvas>
    </div>
    <footer></footer>

    <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {

            const socket = io();

            const canvas = document.getElementById('canvas');
            const canvasContainer = document.getElementById('canvasContainer');
            const ctx = canvas.getContext('2d');
            const size = Math.min(canvasContainer.offsetWidth, canvasContainer.offsetHeight);
            const heartsContainer = document.getElementById('hearts');
            
            canvas.width = size;
            canvas.height = size;

            let gridSize;
            let x;
            let y;
            let EndX;
            let EndY;
            let blockSize;
            let vector2D;
            let traps = [];

            // requestDeviceOrientation();
            // resetHearts();
            // startGame(5);
            // setInterval(update, 150);

            // function startGame(difficulty) {
            //     ctx.clearRect(0, 0, size, size);
            //     getInitialData();
            //     drawMaze();            
            //     drawBall(x, y, '#c80000');
            //     drawBall(EndX, EndY, 'black');
            //     drawTraps();
            //     resetHearts();
            // }

            socket.on('start', () => {
                ctx.clearRect(0, 0, size, size);
                // getInitialData();

                blockSize = size/gridSize;
                drawMaze();            
                drawBall(x, y, '#c80000');
                drawBall(EndX, EndY, 'black');
                drawTraps();
                resetHearts();

                console.log(`Start received`);
            });
            
            // function getInitialData() {
            //     //get all this data
            //     vector2D;
            //     gridSize;
            //     x;
            //     y;
            //     EndX;
            //     EndY;
            //     traps = []

            //     blockSize = size/gridSize;
            // }
            socket.on('getInitialData', (data) => {
                vector2D = data.vector2D;
                gridSize = data.gridSize;
                x = data.x;
                y = data.y;
                EndX = data.EndX;
                EndY = data.EndY;
                traps = data.traps;

                console.log(`Data received: ${JSON.stringify(data)}`);
            });

            // socket.on('remove_heart', (lives) => {
            //     while (hearts.length > 0) {
            //         hearts[hearts.length - 1].remove();
            //     }
            //     const heartsContainer = document.getElementById('hearts');
            //     heartsContainer.innerHTML = '';
            //     for (let i = 0; i < lives; i++) {
            //         const heart = document.createElement('img');
            //         heart.src = 'heart.png';
            //         heart.alt = 'Heart';
            //         heart.width = 30;
            //         heart.height = 30;
            //         heartsContainer.appendChild(heart);
            //     }
            //     hearts = heartsContainer.getElementsByTagName('img');
            // });

            let hearts = Array.from(heartsContainer.getElementsByTagName('img')); // Convert to array
            socket.on('remove_heart', (lives) => {
                hearts.forEach((heart, index) => {
                    heart.style.display = index < lives ? 'inline' : 'none'; // Show/hide based on lives
                });
            });

            function drawMaze() {

                for (let i = 0; i < vector2D.length; i++) {
                    for (let j = 0; j < vector2D[i].length; j++) {
                        if (vector2D[i][j] == 1) {
                            drawSquare(j, i, '#000000');
                        }
                    }
                }
            }
            
            function drawSquare(xPos, yPos, color) {
                ctx.fillStyle = color;
                ctx.fillRect(xPos * blockSize, yPos * blockSize, blockSize, blockSize);
            }

            function drawBall(xPos, yPos, color) {
                const centerX = xPos * blockSize + blockSize / 2;
                const centerY = yPos * blockSize + blockSize / 2;
                ctx.beginPath();
                ctx.arc(centerX, centerY, blockSize / 2 - 1, 0, Math.PI * 2);
                ctx.fillStyle = color;
                ctx.fill();
                ctx.closePath();
            }

            function drawTraps() {
                for (let trap of traps) {
                    const xPos = trap[0];
                    const yPos = trap[1];
                    drawBall(xPos, yPos, 'yellow'); // Replace 'red' with your desired color
                }
            }
            
            function handleOrientation(event) {
                let betta = event.beta;
                let gamma = event.gamma;
                //give betta and gamma

                data = {beta:betta, gamma:gamma};

                console.log(`Sending beta-gamma data: ${JSON.stringify(data)}`);

                socket.emit('beta_gamma', data);
            }

            // function Update(){//when reqeusted
            //     tx.clearRect(x * blockSize, y * blockSize, blockSize, blockSize);
            //     //get x and y
            //     drawBall(x, y, '#c80000');
            // }

            socket.on('pos_update', (data) => {
                console.log(`x,y: ${data.x}, ${data.y}`);

                ctx.clearRect(x * blockSize, y * blockSize, blockSize, blockSize);
                x = data.x;
                y = data.y;
                drawBall(data.x, data.y, '#c80000');
            });
    
            async function requestDeviceOrientation() {
                if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                    try {
                        const permissionState = await DeviceOrientationEvent.requestPermission();
                        if (permissionState === 'granted') {
                            window.addEventListener('deviceorientation', handleOrientation);
                        } else {
                            alert('Permission was denied');
                        }
                    } catch (error) {
                        alert(error);
                    }
                } else if ('DeviceOrientationEvent' in window) {
                    console.log("not iOS");
                    window.addEventListener('deviceorientation', handleOrientation);
                } else {
                    alert('not supported');
                }
            }

            function resetHearts() {
                let lives = 5;
                // const heartsContainer = document.getElementById('hearts');
                heartsContainer.innerHTML = '';
                for (let i = 0; i < 5; i++) {
                    const heart = document.createElement('img');
                    heart.src = 'heart.png';
                    heart.alt = 'Heart';
                    heart.width = 30;
                    heart.height = 30;
                    heartsContainer.appendChild(heart);
                }
                hearts = heartsContainer.getElementsByTagName('img');
            }

            // function removeHeart() {
            //     if (hearts.length > 0) {
            //         hearts[hearts.length - 1].remove();
            //     }
            // }


            document.getElementById('restartButton').addEventListener('click', () => {
                requestDeviceOrientation();          
            });
        });

        // Example usage of removeHeart
        // Call removeHeart() function whenever you want to remove a heart, e.g., on some event.
    </script>
</body>
</html>
